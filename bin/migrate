#!/bin/bash
set -e

MIGRATIONS_DIR="backend/db/migrations"
DB_URL="${DATABASE_URL:-postgres://postgres:postgres@localhost:5432/chronos?sslmode=disable}"

# Check for goose
if ! command -v goose &> /dev/null; then
  echo "Installing goose..."
  go install github.com/pressly/goose/v3/cmd/goose@latest
fi

# Ensure migrations directory exists
mkdir -p "$MIGRATIONS_DIR"

usage() {
  echo "Usage: ./bin/migrate <command>"
  echo ""
  echo "Commands:"
  echo "  create <name>   Create a new migration (e.g. create add_jobs_table)"
  echo "  up              Run all pending migrations"
  echo "  down            Roll back the last migration"
  echo "  status          Show migration status"
  exit 1
}

case "${1}" in
  create)
    if [ -z "${2}" ]; then
      echo "Error: migration name required"
      echo "Usage: ./bin/migrate create <name>"
      exit 1
    fi
    goose -dir "$MIGRATIONS_DIR" -s create "${2}" sql
    ;;
  up)
    goose -dir "$MIGRATIONS_DIR" postgres "$DB_URL" up
    ;;
  down)
    goose -dir "$MIGRATIONS_DIR" postgres "$DB_URL" down
    ;;
  status)
    goose -dir "$MIGRATIONS_DIR" postgres "$DB_URL" status
    ;;
  *)
    usage
    ;;
esac
